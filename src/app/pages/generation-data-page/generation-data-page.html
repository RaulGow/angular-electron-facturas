<div class="container">
  <h2>Crear Nueva Factura</h2>
  <form [formGroup]="invoiceForm" (ngSubmit)="onSubmit()">

    <div class="header-fields">
      <mat-form-field appearance="outline">
        <mat-label>Cliente</mat-label>
        <input matInput formControlName="customer" placeholder="Nombre del Cliente">
      </mat-form-field>

      <mat-form-field appearance="outline">
        <mat-label>Fecha</mat-label>
        <input matInput [matDatepicker]="picker" formControlName="date">
        <mat-hint>DD/MM/YYYY</mat-hint>
        <mat-datepicker-toggle matIconSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
      </mat-form-field>
    </div>

    <hr>

    <div formArrayName="items">
      <div *ngFor="let item of items.controls; let i=index" [formGroupName]="i" class="item-row">

        <mat-form-field appearance="fill" class="col-desc">
          <mat-label>Artículo / Producto</mat-label>
          <input type="text"
                 matInput
                 formControlName="description"
                 [matAutocomplete]="auto">
          <mat-autocomplete #auto="matAutocomplete" (optionSelected)="onProductSelect(i)">
            @for (option of getFilteredOptions(i); track option.codigo) {
              <mat-option [value]="option.nombre">
                {{ option.nombre }} <span class="price-hint">({{ option.precio }}€)</span>
              </mat-option>
            }
          </mat-autocomplete>
        </mat-form-field>

        <mat-form-field appearance="fill" class="col-qty">
          <mat-label>Cant.</mat-label>
          <input type="number" matInput formControlName="quantity">
        </mat-form-field>

        <mat-form-field appearance="fill" class="col-price">
          <mat-label>Precio €</mat-label>
          <input type="number" matInput formControlName="price">
        </mat-form-field>

        <div class="col-subtotal">
          <small>Subtotal</small>
          <p>{{ (item.get('quantity')?.value * item.get('price')?.value) | currency:'EUR' }}</p>
        </div>

        <button type="button" mat-icon-button color="warn" (click)="removeItem(i)" class="btn-delete">
          <span>×</span>
        </button>
      </div>
    </div>

    <div class="footer-actions">
      <button type="button" mat-stroked-button color="primary" (click)="addItem()">+ Añadir Línea</button>
      <button type="submit" mat-raised-button color="primary" [disabled]="invoiceForm.invalid">Generar Factura</button>
    </div>
  </form>
</div>
